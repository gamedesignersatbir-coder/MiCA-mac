<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiCA | Strategy Prompt Sandbox v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712;
            color: white;
        }

        .glass {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        @keyframes pulse-slow {

            0%,
            100% {
                opacity: 0.3;
            }

            50% {
                opacity: 0.6;
            }
        }

        .animate-pulse-slow {
            animation: pulse-slow 3s infinite;
        }

        .tab-active {
            border-bottom: 2px solid #6366f1;
            color: white;
        }

        @media print {
            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            body {
                background: white;
                color: black;
            }
        }
    </style>
</head>

<body class="min-h-screen flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header
        class="no-print border-b border-gray-800 bg-gray-900/50 px-6 py-3 flex items-center justify-between z-50 backdrop-blur-md">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-indigo-500/10 rounded-lg text-indigo-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
                </svg>
            </div>
            <div>
                <h1 class="text-base font-bold">MiCA Strategy Sandbox <span
                        class="text-indigo-500 ml-1 text-[10px] bg-indigo-500/10 px-1.5 py-0.5 rounded">v3</span></h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-tight">Deep Strategy Upgrade</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="relative">
                <input type="password" id="apiKey" placeholder="OpenRouter API Key"
                    class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-xs w-64 focus:ring-1 focus:ring-indigo-500 outline-none pr-10">
                <button id="showKey" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                </button>
            </div>
            <button id="saveKey"
                class="text-[10px] font-bold bg-indigo-600/20 text-indigo-400 border border-indigo-500/30 hover:bg-indigo-600/40 px-3 py-1.5 rounded-lg transition-colors">SAVE
                KEY</button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <!-- Sidebar: Advanced Prompt Controls -->
        <aside class="no-print w-1/4 border-r border-gray-800 flex flex-col bg-gray-950/50">
            <div class="p-4 border-b border-gray-800 space-y-3">
                <div class="flex items-center justify-between">
                    <h2 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Persona Presets</h2>
                    <span class="text-[9px] text-gray-600">Switch Mindsets</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setPersona('creative')"
                        class="bg-purple-600/10 border border-purple-500/30 text-[10px] py-1.5 rounded hover:bg-purple-600/20 transition-all">Creative</button>
                    <button onclick="setPersona('analytical')"
                        class="bg-blue-600/10 border border-blue-500/30 text-[10px] py-1.5 rounded hover:bg-blue-600/20 transition-all">Analytical</button>
                    <button onclick="setPersona('growth')"
                        class="bg-emerald-600/10 border border-emerald-500/30 text-[10px] py-1.5 rounded hover:bg-emerald-600/20 transition-all">Growth</button>
                    <button onclick="setPersona('reset')"
                        class="bg-gray-800 text-[10px] py-1.5 rounded hover:bg-gray-700 transition-all">Reset
                        Default</button>
                </div>
            </div>
            <div class="p-4 border-b border-gray-800">
                <h2 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">System Prompt</h2>
                <textarea id="systemPrompt"
                    class="w-full h-32 bg-gray-900 border border-gray-800 rounded-lg p-3 text-[11px] font-mono text-indigo-300 focus:ring-1 focus:ring-indigo-500 outline-none resize-none"
                    placeholder="System prompt..."></textarea>
            </div>
            <div class="flex-1 p-4 flex flex-col">
                <h2 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">User Prompt Template</h2>
                <textarea id="userPromptTemplate"
                    class="flex-1 w-full bg-gray-900 border border-gray-800 rounded-lg p-3 text-[11px] font-mono text-gray-400 focus:ring-1 focus:ring-indigo-500 outline-none resize-none leading-tight"
                    placeholder="User prompt template..."></textarea>
            </div>
        </aside>

        <!-- Center: 1:1 Form -->
        <section class="no-print flex-1 flex flex-col bg-gray-900/20 border-r border-gray-800">
            <div class="p-4 border-b border-gray-800 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h2 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Campaign Parameters</h2>
                    <select id="frameworkSelect"
                        class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-[10px] text-gray-400 focus:ring-1 focus:ring-indigo-500 outline-none">
                        <option value="none">Basic Strategy</option>
                        <option value="aida">AIDA Framework</option>
                        <option value="stp">STP Model (Segment, Target, Position)</option>
                        <option value="growth">Growth Loops & Viral Engine</option>
                        <option value="blueocean">Blue Ocean Strategy</option>
                    </select>
                </div>
                <button id="generateBtn"
                    class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg font-bold text-xs transition-all transform active:scale-95 flex items-center gap-2 shadow-lg shadow-indigo-500/20">
                    <svg id="sparkleIcon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path
                            d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />
                    </svg>
                    <span>Run Deep Strategy Test</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                <form id="campaignForm" class="grid grid-cols-2 gap-x-6 gap-y-4 pb-12">
                    <div class="col-span-2 space-y-1">
                        <label class="text-[10px] uppercase font-bold text-gray-500">Creator Name</label>
                        <input name="creator_name" type="text"
                            class="w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-indigo-500"
                            placeholder="e.g. Arjun">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] uppercase font-bold text-gray-500">Product Name</label>
                        <input name="product_name" type="text"
                            class="w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-indigo-500"
                            placeholder="Product name">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] uppercase font-bold text-gray-500">Launch Date</label>
                        <input name="launch_date" type="date"
                            class="w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-indigo-500">
                    </div>
                    <div class="col-span-2 space-y-1">
                        <label class="text-[10px] uppercase font-bold text-gray-500">Product Links</label>
                        <input name="product_links" type="text"
                            class="w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-indigo-500"
                            placeholder="https://...">
                    </div>
                    <div class="col-span-2 space-y-1">
                        <label class="text-[10px] uppercase font-bold text-gray-500">Product Description</label>
                        <textarea name="product_description" rows="3"
                            class="w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-indigo-500 resize-none"></textarea>
                    </div>
                    <div class="col-span-2 space-y-1">
                        <label class="text-[10px] uppercase font-bold text-gray-500">Target Audience</label>
                        <textarea name="target_audience" rows="2"
                            class="w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-indigo-500 resize-none"
                            placeholder="e.g. Working professionals aged 25-40..."></textarea>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] uppercase font-bold text-gray-500">Budget (INR)</label>
                        <input name="budget" type="number" value="5000"
                            class="w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-indigo-500">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] uppercase font-bold text-gray-500">Location</label>
                        <input name="location" type="text"
                            class="w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-indigo-500"
                            placeholder="e.g. pan India">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] uppercase font-bold text-gray-500">Tone</label>
                        <select name="tone"
                            class="w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-indigo-500 text-white">
                            <option>Professional</option>
                            <option>Warm & Inspirational</option>
                            <option>Urgent</option>
                            <option>Casual</option>
                            <option>Custom</option>
                        </select>
                    </div>
                    <div class="col-span-2 space-y-4 pt-4 border-t border-gray-800">
                        <div class="flex items-center justify-between">
                            <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Document &
                                Customer Data</h3>
                            <p class="text-[8px] text-gray-600">Files parsed locally</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-[10px] text-gray-400">Product Document</label>
                                <input type="file" id="docUpload" class="hidden">
                                <button type="button" onclick="document.getElementById('docUpload').click()"
                                    class="w-full border border-dashed border-gray-800 rounded-lg py-4 text-[10px] text-gray-500 hover:border-indigo-500 hover:text-indigo-400 flex flex-col items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                        <polyline points="17 8 12 3 7 8" />
                                        <line x1="12" x2="12" y1="3" y2="15" />
                                    </svg>
                                    <span id="docStatus">UPLOAD DOC</span>
                                </button>
                                <textarea id="docContent" class="hidden"></textarea>
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] text-gray-400">Customer CSV</label>
                                <input type="file" id="csvUpload" class="hidden">
                                <button type="button" onclick="document.getElementById('csvUpload').click()"
                                    class="w-full border border-dashed border-gray-800 rounded-lg py-4 text-[10px] text-gray-500 hover:border-blue-500 hover:text-blue-400 flex flex-col items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                                        <circle cx="9" cy="7" r="4" />
                                        <polyline points="22 21 18 17 22 13" />
                                    </svg>
                                    <span id="csvStatus">UPLOAD CSV</span>
                                </button>
                                <textarea id="csvContent" class="hidden"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </section>

        <!-- Right: Results -->
        <aside id="outputPane" class="w-1/3 flex flex-col bg-gray-950/50">
            <div class="p-4 border-b border-gray-800 flex items-center justify-between no-print">
                <h2 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Strategy Result</h2>
                <div class="flex items-center gap-2">
                    <button onclick="toggleVisual('json')" id="jsonToggle"
                        class="text-[9px] font-bold text-indigo-400 tab-active pb-1 px-1">JSON</button>
                    <button onclick="toggleVisual('doc')" id="docToggle"
                        class="text-[9px] font-bold text-gray-500 pb-1 px-1">REPORT</button>
                </div>
                <div id="statusIndicator" class="hidden flex items-center gap-2">
                    <div class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></div>
                </div>
            </div>
            <div class="flex-1 p-6 overflow-y-auto custom-scrollbar relative" id="resultScrollbox">
                <div id="welcomeMessage"
                    class="flex flex-col items-center justify-center h-full text-center space-y-4 opacity-30 no-print">
                    <div class="p-6 border border-gray-800 rounded-3xl animate-pulse-slow">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                            class="text-gray-700">
                            <path
                                d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
                            <line x1="12" x2="12" y1="22.08" y2="12" />
                        </svg>
                    </div>
                </div>

                <div id="resultContent" class="hidden space-y-6">
                    <div id="jsonView">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[9px] font-bold text-gray-600 uppercase">RAW OUTPUT</span>
                            <button onclick="copyRaw()"
                                class="text-[9px] text-indigo-400 hover:text-white uppercase font-bold">Copy</button>
                        </div>
                        <pre id="jsonOutput"
                            class="bg-black/40 border border-gray-800 rounded-lg p-4 text-[11px] font-mono text-indigo-300 overflow-x-auto custom-scrollbar"></pre>
                    </div>

                    <div id="docView" class="hidden space-y-8 pb-12">
                        <!-- Printed dynamically -->
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-800 no-print">
                <button onclick="window.print()"
                    class="w-full border border-gray-700 rounded py-2 text-[10px] font-bold text-gray-400 hover:bg-gray-800 transition-all uppercase tracking-widest">Export
                    as PDF</button>
            </div>
        </aside>
    </main>

    <script>
        const PERSONAS = {
            default: `You are an expert marketing strategist. Return ONLY valid JSON. No markdown.`,
            creative: `You are a visionary Creative Director at a top-tier agency like Ogilvy. You prioritize storytelling, emotional resonance, and "The Big Idea." Your strategies should feel bold, disruptive, and narrative-driven.`,
            analytical: `You are a Data-Driven Growth Lead at a Silicon Valley unicorn. You prioritize CAC/LTV, funnel math, and statistical significance. Your strategies should be ruthlessly efficient, focused on high-intent segments and conversion optimization.`,
            growth: `You are a Growth Hacker focused on viral mechanics and low-cost distribution. You prioritize loops over funnels and look for unconventional channels. Your strategies should be fast-paced and experimental.`
        };

        const FRAMEWORKS = {
            aida: "Use the AIDA (Attention, Interest, Desire, Action) framework to structure your strategy. Ensure each week moves the user through these stages.",
            stp: "Use the STP (Segmentation, Targeting, Positioning) model. Clearly define the segment you are winning and why your positioning beats competitors.",
            growth: "Focus on Growth Loops. How does one user bring the next? Focus on viral coefficients and retention hacks.",
            blueocean: "Use Blue Ocean Strategy. Find where the 'red ocean' competitors are fighting and suggest a 'blue ocean' strategy that makes them irrelevant."
        };

        const DEFAULT_SYSTEM_PROMPT = `${PERSONAS.default}
The output MUST be a DEEP, COMPREHENSIVE strategy in valid JSON. Do not include any text before or after the JSON.
{
  "campaign_name": "string",
  "tagline": "A powerful 1-sentence hook",
  "strategy_summary": "Extensive paragraph explaining the 'Why'",
  "unique_value_prop": "The core transformation offered",
  "audience_pain_points": ["detailed string describing a specific pain"],
  "creative_hooks": ["specific copy or visual ideas"],
  "target_persona": "A detailed 4-5 sentence archetype",
  "weekly_plan": [{ "week": 1, "theme": "string", "goal": "string", "tactics": [{ "day": 1, "channel": "string", "action": "string", "description": "min 2 sentences of instruction" }] }],
  "budget_allocation": { "channel": number },
  "expected_outcomes": { "reach": "string", "engagement": "string", "conversion": "string" }
}
STRICT RULE: YOUR ENTIRE RESPONSE MUST BE A SINGLE JSON OBJECT.`;

        const DEFAULT_USER_TEMPLATE = `Build a professional marketing strategy using the following parameters:
{{framework_instruction}}

[INPUT DATA]
Creator: {{creator_name}}
Product: {{product_name}}
Description: {{product_description}}
Links: {{product_links}}
Target: {{target_audience}}
Geo: {{location}}
Tone: {{tone}}
Budget: ₹{{budget}}

[DOCUMENTS]
{{document_content}}

[CUSTOMER DATA]
{{csv_content}}

Instructions: Provide a high-density, detailed response. Each tactic must be actionable and described in detail.`;

        // Logic
        function setPersona(p) {
            const prompt = p === 'reset' ? DEFAULT_SYSTEM_PROMPT : `${PERSONAS[p]}\n\n${DEFAULT_SYSTEM_PROMPT.split('\n\n')[1]}`;
            document.getElementById('systemPrompt').value = prompt;
            localStorage.setItem('mica_system_prompt', prompt);
        }

        function toggleVisual(v) {
            document.getElementById('jsonView').classList.toggle('hidden', v === 'doc');
            document.getElementById('docView').classList.toggle('hidden', v === 'json');
            document.getElementById('jsonToggle').className = v === 'json' ? 'text-[9px] font-bold text-indigo-400 tab-active pb-1 px-1' : 'text-[9px] font-bold text-gray-500 pb-1 px-1';
            document.getElementById('docToggle').className = v === 'doc' ? 'text-[9px] font-bold text-indigo-400 tab-active pb-1 px-1' : 'text-[9px] font-bold text-gray-500 pb-1 px-1';
        }

        // Init & Save
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('apiKey').value = localStorage.getItem('mica_api_key') || '';
            document.getElementById('systemPrompt').value = localStorage.getItem('mica_system_prompt') || DEFAULT_SYSTEM_PROMPT;
            document.getElementById('userPromptTemplate').value = localStorage.getItem('mica_user_template') || DEFAULT_USER_TEMPLATE;

            [document.getElementById('systemPrompt'), document.getElementById('userPromptTemplate')].forEach(el => {
                el.addEventListener('input', () => localStorage.setItem(`mica_${el.id === 'systemPrompt' ? 'system_prompt' : 'user_template'}`, el.value));
            });

            document.getElementById('saveKey').onclick = () => {
                const key = document.getElementById('apiKey').value;
                localStorage.setItem('mica_api_key', key);
                alert('API Key saved to browser.');
            };

            document.getElementById('showKey').onclick = () => {
                const input = document.getElementById('apiKey');
                input.type = input.type === 'password' ? 'text' : 'password';
            };
        });

        // File Parsing
        ['docUpload', 'csvUpload'].forEach(id => {
            document.getElementById(id).addEventListener('change', function (e) {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    document.getElementById(id === 'docUpload' ? 'docContent' : 'csvContent').value = text;
                    document.getElementById(id === 'docUpload' ? 'docStatus' : 'csvStatus').innerText = file.name.toUpperCase();
                };
                reader.readAsText(file);
            });
        });

        // Run
        document.getElementById('generateBtn').addEventListener('click', async () => {
            const key = document.getElementById('apiKey').value; if (!key) return alert('API Key Required');

            const formData = new FormData(document.getElementById('campaignForm'));
            const raw = Object.fromEntries(formData.entries());
            raw.document_content = document.getElementById('docContent').value || "None";
            raw.csv_content = document.getElementById('csvContent').value || "None";

            const fValue = document.getElementById('frameworkSelect').value;
            raw.framework_instruction = fValue !== 'none' ? `[STRATEGY FRAMEWORK: ${fValue.toUpperCase()}]\n${FRAMEWORKS[fValue]}` : "";

            let finalUserPrompt = document.getElementById('userPromptTemplate').value;
            // Use split/join to replace all occurrences efficiently
            Object.keys(raw).forEach(f => {
                const val = raw[f] || "None";
                finalUserPrompt = finalUserPrompt.split(`{{${f}}}`).join(val);
            });

            document.getElementById('generateBtn').disabled = true;
            document.getElementById('statusIndicator').classList.remove('hidden');
            document.getElementById('sparkleIcon').classList.add('animate-spin');

            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${key}`,
                        "Content-Type": "application/json",
                        "X-Title": "MiCA Strategy Sandbox",
                        "HTTP-Referer": window.location.origin
                    },
                    body: JSON.stringify({
                        model: "anthropic/claude-3.5-sonnet",
                        messages: [
                            { role: "system", content: document.getElementById('systemPrompt').value },
                            { role: "user", content: finalUserPrompt }
                        ],
                        temperature: 0.5
                    })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error?.message || `API Error: ${res.status}`);
                }

                const data = await res.json();
                console.log("API Response Status:", res.status);
                console.log("API Full Response:", data);

                if (!data.choices || !data.choices[0]) throw new Error("Invalid API Response Structure");

                const content = data.choices[0].message.content;
                console.log("Raw AI Content:", content);

                const firstBrace = content.indexOf('{');
                const lastBrace = content.lastIndexOf('}');

                if (firstBrace === -1 || lastBrace === -1) {
                    console.error("No JSON braces found in content:", content);
                    // Fallback: Show raw text in the JSON view instead of crashing
                    document.getElementById('welcomeMessage').classList.add('hidden');
                    document.getElementById('resultContent').classList.remove('hidden');
                    document.getElementById('jsonOutput').textContent = content;
                    toggleVisual('json');
                    throw new Error("The AI returned plain text instead of JSON. You can see the raw output in the 'JSON' tab.");
                }

                const jsonStr = content.substring(firstBrace, lastBrace + 1);
                const json = JSON.parse(jsonStr);
                render(json);
            } catch (err) {
                console.error("DEBUG ERROR:", err);
                alert(`${err.message}`);
            }
            finally {
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('statusIndicator').classList.add('hidden');
                document.getElementById('sparkleIcon').classList.remove('animate-spin');
            }
        });

        function render(data) {
            document.getElementById('welcomeMessage').classList.add('hidden');
            document.getElementById('resultContent').classList.remove('hidden');
            document.getElementById('jsonOutput').textContent = JSON.stringify(data, null, 2);

            // Utility to get values from multiple possible key names or paths
            const get = (obj, ...paths) => {
                for (const path of paths) {
                    const keys = path.split('.');
                    let val = obj;
                    for (const k of keys) {
                        val = (val && typeof val === 'object') ? val[k] : undefined;
                    }
                    if (val !== undefined && val !== "" && val !== null) return val;
                }
                return "";
            };

            const campaignName = get(data, 'campaign_name', 'campaignName', 'name', 'strategy.name', 'strategy.campaign_name') || "Strategy Report";
            const tagline = get(data, 'tagline', 'hook', 'core_message', 'strategy.core_message', 'strategy.tagline') || "Strategic Execution Plan";
            const strategySummary = get(data, 'strategy_summary', 'strategySummary', 'summary', 'strategic_thesis', 'strategy.overview', 'overview', 'strategy.strategy_summary');

            // Handle Persona (could be string or object)
            let targetPersona = get(data, 'target_persona', 'targetPersona', 'persona', 'target_archetype', 'strategy.target_persona', 'strategy.target_archetype');
            if (typeof targetPersona === 'object') {
                targetPersona = targetPersona.primary || targetPersona.description || targetPersona.archetype || JSON.stringify(targetPersona);
            }

            // Handle Weekly Plan / Pillars (could be 'tactics' array directly, or 'growth_pillars')
            let stages = get(data, 'weekly_plan', 'weeklyPlan', 'plan', 'growth_pillars', 'pillars', 'strategy.weekly_plan', 'strategy.growth_pillars');

            if (!stages || !Array.isArray(stages)) {
                const tactics = get(data, 'tactics', 'strategy.tactics');
                if (Array.isArray(tactics)) {
                    stages = [{
                        week: 1,
                        theme: "Strategic Execution",
                        goal: "Implement Core Tactics",
                        tactics: tactics
                    }];
                } else {
                    stages = [];
                }
            }

            const doc = document.getElementById('docView');
            doc.innerHTML = `
                <div class="border-b-2 border-indigo-500 pb-4">
                    <h1 class="text-3xl font-bold text-white mb-2">${campaignName}</h1>
                    <p class="text-indigo-400 font-medium italic">"${tagline}"</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest border-b border-gray-800 pb-2">Strategic Thesis</h3>
                        <p class="text-sm leading-relaxed text-gray-300 font-medium">${strategySummary || "No summary provided."}</p>
                        
                        <div class="bg-gray-900/40 p-5 rounded-2xl border border-gray-800 space-y-3">
                            <h4 class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">Pain Points We Solve</h4>
                            <ul class="space-y-2">
                                ${(get(data, 'audience_pain_points', 'audiencePainPoints', 'pain_points', 'strategy.audience_pain_points') || ["No specific pain points listed."]).map(p => `
                                    <li class="text-[11px] text-gray-400 flex gap-2"><span class="text-indigo-500">•</span> ${p}</li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest border-b border-gray-800 pb-2">Target Archetype</h3>
                        <div class="bg-indigo-500/5 p-4 rounded-xl border border-indigo-500/10">
                            <p class="text-[11px] leading-relaxed text-gray-300 italic">${targetPersona || "No persona details provided."}</p>
                        </div>
                        <div class="space-y-3 pt-2">
                            <p class="text-[10px] font-bold text-gray-500 uppercase">Creative Direction</p>
                            <div class="flex flex-wrap gap-2">
                                ${(get(data, 'creative_hooks', 'creativeHooks', 'hooks', 'strategy.creative_hooks') || ["No hooks provided."]).map(h => `
                                    <span class="bg-gray-800 px-3 py-1.5 rounded-full text-[10px] text-gray-300 border border-gray-700">${h}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6 pt-10">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest border-b border-gray-800 pb-4">Execution Strategy</h3>
                    ${stages.map((s, idx) => {
                const stageTitle = get(s, 'week', 'number', 'pillar', 'name') || (idx + 1);
                const stageHeading = get(s, 'theme', 'title', 'pillar_name', 'name');
                const stageSub = get(s, 'goal', 'objective', 'description');
                const tactics = get(s, 'tactics', 'steps', 'actions', 'execution_steps') || [];

                return `
                        <div class="relative pl-8 border-l border-gray-800 space-y-4 pb-8">
                            <div class="absolute -left-[5px] top-0 w-[9px] h-[9px] bg-indigo-500 rounded-full shadow-[0_0_10px_#6366f1]"></div>
                            <div>
                                <h4 class="text-white font-bold text-sm">STAGE ${stageTitle}: ${stageHeading}</h4>
                                ${stageSub ? `<p class="text-[11px] text-indigo-400/80 font-medium mb-3">${stageSub}</p>` : ''}
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${tactics.map(t => {
                    if (typeof t === 'string') return `
                                        <div class="bg-gray-900/60 p-4 rounded-xl border border-gray-800 space-y-2 h-full">
                                            <p class="text-[11px] text-white font-bold leading-tight">${t}</p>
                                        </div>`;

                    const tName = get(t, 'action', 'title', 'task', 'name');
                    const tDesc = get(t, 'description', 'details', 'instruction', 'overview');
                    const tChan = get(t, 'channel', 'platform', 'type');
                    const subActions = get(t, 'actions', 'steps', 'sub_tasks');

                    return `
                                    <div class="bg-gray-900/60 p-4 rounded-xl border border-gray-800 space-y-2 h-full">
                                        <div class="flex items-center justify-between">
                                            <span class="text-[9px] font-black text-gray-600 uppercase bg-gray-800 px-2 py-0.5 rounded">${tChan || 'Strategy'}</span>
                                        </div>
                                        <p class="text-[11px] text-white font-bold leading-tight">${tName}</p>
                                        <p class="text-[10px] text-gray-500 leading-relaxed">${tDesc}</p>
                                        ${Array.isArray(subActions) ? `
                                            <div class="mt-2 space-y-1">
                                                ${subActions.map(sa => `<p class="text-[9px] text-gray-400 border-l border-indigo-500/30 pl-2">${typeof sa === 'string' ? sa : (sa.action || sa.name || JSON.stringify(sa))}</p>`).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `}).join('')}
                            </div>
                        </div>`;
            }).join('')}
                </div>
            `;
            toggleVisual('doc');
        }

        function copyRaw() {
            navigator.clipboard.writeText(document.getElementById('jsonOutput').textContent); alert('Strategy JSON Copied');
        }
    </script>
</body>

</html>